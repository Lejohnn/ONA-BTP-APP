<!DOCTYPE html>
<html>
<head>
    <title>Test API D√©tail T√¢che</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="number"] { width: 200px; padding: 8px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test API D√©tail T√¢che</h1>
        <p>Entrez l'ID d'une t√¢che pour analyser les donn√©es disponibles</p>
        
        <div class="form-group">
            <label for="taskId">ID de la t√¢che :</label>
            <input type="number" id="taskId" value="1" placeholder="Ex: 1">
        </div>
        
        <button onclick="testTaskDetail()">üîç Tester les donn√©es de la t√¢che</button>
        
        <div id="result"></div>
    </div>

    <script>
        async function testTaskDetail() {
            const taskId = document.getElementById('taskId').value;
            const resultDiv = document.getElementById('result');
            
            if (!taskId) {
                resultDiv.innerHTML = '<div class="error">Veuillez entrer un ID de t√¢che</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="success">üîÑ Chargement en cours...</div>';
            
            const url = 'https://btp.onaerp.com/jsonrpc/web/dataset/search_read';
            const data = {
                jsonrpc: "2.0",
                method: "call",
                params: {
                    model: "project.task",
                    method: "search_read",
                    args: [],
                    kwargs: {
                        domain: [['id', '=', parseInt(taskId)]],
                        fields: [
                            // Champs de base
                            'id', 'name', 'description', 'display_name',
                            
                            // Relations
                            'project_id', 'user_id', 'stage_id', 'partner_id',
                            
                            // √âtat et progression
                            'state', 'priority', 'progress', 'kanban_state',
                            
                            // Dates
                            'date_deadline', 'date_start', 'date_end', 'create_date', 'write_date',
                            
                            // Heures
                            'effective_hours', 'remaining_hours', 'total_hours_spent', 'planned_hours',
                            
                            // Relations complexes
                            'parent_id', 'child_ids', 'depend_on_ids',
                            
                            // Sous-t√¢ches
                            'subtask_planned_hours', 'subtask_effective_hours', 'subtask_count',
                            
                            // Communication
                            'email_from', 'email_cc', 'email_bcc',
                            
                            // Heures de travail
                            'working_hours_open', 'working_hours_close', 'working_days_open', 'working_days_close',
                            
                            // Autres
                            'company_id', 'color', 'user_email', 'create_uid', 'write_uid',
                            
                            // Messages et activit√©s
                            'message_ids', 'message_follower_ids', 'message_channel_ids', 'message_partner_ids',
                            'activity_ids', 'activity_state', 'activity_type_id', 'activity_date_deadline',
                            'activity_summary', 'activity_note', 'activity_user_id',
                            
                            // Tags et cat√©gories
                            'tag_ids',
                            
                            // Timesheet
                            'timesheet_ids', 'timesheet_unit_amount'
                        ],
                        limit: 1
                    }
                }
            };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'btp_authentication_token': 'demo'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                console.log('üì¶ R√©ponse compl√®te:', result);
                
                if (result.error) {
                    resultDiv.innerHTML = `<div class="error">
                        <h3>‚ùå Erreur API</h3>
                        <pre>${JSON.stringify(result.error, null, 2)}</pre>
                    </div>`;
                    return;
                }
                
                if (result.result && result.result.records && result.result.records.length > 0) {
                    const task = result.result.records[0];
                    
                    // Analyse des donn√©es
                    const analysis = analyzeTaskData(task);
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <h3>‚úÖ T√¢che trouv√©e (ID: ${task.id})</h3>
                            <h4>üìã Donn√©es brutes :</h4>
                            <pre>${JSON.stringify(task, null, 2)}</pre>
                            
                            <h4>üîç Analyse des donn√©es :</h4>
                            <pre>${JSON.stringify(analysis, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `<div class="error">
                        <h3>‚ùå T√¢che non trouv√©e</h3>
                        <p>Aucune t√¢che trouv√©e avec l'ID ${taskId}</p>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    </div>`;
                }
                
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">
                    <h3>‚ùå Erreur de connexion</h3>
                    <p>${error.message}</p>
                </div>`;
            }
        }
        
        function analyzeTaskData(task) {
            const analysis = {
                basicInfo: {
                    id: task.id,
                    name: task.name,
                    description: task.description,
                    displayName: task.display_name,
                    hasDescription: !!task.description,
                    descriptionLength: task.description ? task.description.length : 0
                },
                relations: {
                    project: task.project_id,
                    user: task.user_id,
                    stage: task.stage_id,
                    partner: task.partner_id,
                    parent: task.parent_id,
                    children: task.child_ids,
                    dependencies: task.depend_on_ids
                },
                status: {
                    state: task.state,
                    priority: task.priority,
                    progress: task.progress,
                    kanbanState: task.kanban_state
                },
                dates: {
                    deadline: task.date_deadline,
                    start: task.date_start,
                    end: task.date_end,
                    create: task.create_date,
                    write: task.write_date,
                    hasDeadline: !!task.date_deadline,
                    hasStartDate: !!task.date_start,
                    hasEndDate: !!task.date_end
                },
                hours: {
                    effective: task.effective_hours,
                    remaining: task.remaining_hours,
                    totalSpent: task.total_hours_spent,
                    planned: task.planned_hours,
                    subtaskPlanned: task.subtask_planned_hours,
                    subtaskEffective: task.subtask_effective_hours
                },
                subtasks: {
                    count: task.subtask_count,
                    plannedHours: task.subtask_planned_hours,
                    effectiveHours: task.subtask_effective_hours
                },
                communication: {
                    emailFrom: task.email_from,
                    emailCc: task.email_cc,
                    emailBcc: task.email_bcc,
                    userEmail: task.user_email
                },
                workingHours: {
                    open: task.working_hours_open,
                    close: task.working_hours_close,
                    daysOpen: task.working_days_open,
                    daysClose: task.working_days_close
                },
                other: {
                    companyId: task.company_id,
                    color: task.color,
                    createUid: task.create_uid,
                    writeUid: task.write_uid,
                    tagIds: task.tag_ids,
                    timesheetIds: task.timesheet_ids,
                    timesheetUnitAmount: task.timesheet_unit_amount
                },
                messages: {
                    messageIds: task.message_ids,
                    followerIds: task.message_follower_ids,
                    channelIds: task.message_channel_ids,
                    partnerIds: task.message_partner_ids
                },
                activities: {
                    activityIds: task.activity_ids,
                    activityState: task.activity_state,
                    activityTypeId: task.activity_type_id,
                    activityDateDeadline: task.activity_date_deadline,
                    activitySummary: task.activity_summary,
                    activityNote: task.activity_note,
                    activityUserId: task.activity_user_id
                },
                dataQuality: {
                    hasProject: !!task.project_id,
                    hasUser: !!task.user_id,
                    hasStage: !!task.stage_id,
                    hasProgress: task.progress !== undefined && task.progress !== null,
                    hasHours: task.effective_hours !== undefined || task.remaining_hours !== undefined,
                    hasDeadline: !!task.date_deadline,
                    hasSubtasks: task.subtask_count > 0,
                    hasDependencies: task.depend_on_ids && task.depend_on_ids.length > 0
                }
            };
            
            return analysis;
        }
    </script>
</body>
</html>

