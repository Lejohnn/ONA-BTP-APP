<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/projets"></ion-back-button>
    </ion-buttons>
    <ion-title>{{ getPageTitle() }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- État de chargement -->
  <div *ngIf="isLoading" class="loading-state">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Chargement du projet...</p>
  </div>

  <!-- État d'erreur -->
  <div *ngIf="!isLoading && errorMessage" class="error-state">
    <ion-icon name="alert-circle-outline" class="error-icon"></ion-icon>
    <p>{{ errorMessage }}</p>
    <ion-button fill="outline" (click)="retryLoad()">
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      Réessayer
    </ion-button>
  </div>

  <!-- Contenu du projet -->
  <div *ngIf="!isLoading && !errorMessage && projet" class="project-detail-container">
    
    <!-- 1. EN-TÊTE ET INFORMATIONS GÉNÉRALES -->
    <div class="project-header">
      <div class="project-title-section">
        <h1 class="project-title">{{ projet.name }}</h1>
        <div class="project-state-badge" [style.background-color]="getProjectStateColor()">
          {{ projet.state }}
        </div>
      </div>
      
      <div class="project-info-grid">
        <div class="info-item">
          <ion-icon name="location-outline" class="info-icon"></ion-icon>
          <div class="info-content">
            <div class="info-label">Localisation</div>
            <div class="info-value">{{ getProjectLocation() }}</div>
          </div>
        </div>
        
        <div class="info-item">
          <ion-icon name="calendar-outline" class="info-icon"></ion-icon>
          <div class="info-content">
            <div class="info-label">Date de début</div>
            <div class="info-value">{{ projet.getFormattedStartDate() || 'Non définie' }}</div>
          </div>
        </div>
        
        <div class="info-item">
          <ion-icon name="calendar-outline" class="info-icon"></ion-icon>
          <div class="info-content">
            <div class="info-label">Date de fin</div>
            <div class="info-value">{{ projet.getFormattedEndDate() || 'Non définie' }}</div>
          </div>
        </div>
        
        <div class="info-item">
          <ion-icon name="wallet-outline" class="info-icon"></ion-icon>
          <div class="info-content">
            <div class="info-label">Budget total</div>
            <div class="info-value">0 XAF</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 2. BARRE DE PROGRESSION -->
    <div class="progress-section">
      <div class="progress-header">
        <div class="progress-label">Progression du projet</div>
        <div class="progress-percentage">{{ (getProjectProgress() * 100) | number:'1.0-0' }}%</div>
      </div>
      <ion-progress-bar 
        [value]="getProjectProgress()" 
        class="custom-progress-bar">
      </ion-progress-bar>
    </div>

    <!-- 3. INDICATEURS CLÉS -->
    <div class="indicators-section">
      <h2 class="section-title">Indicateurs clés</h2>
      
      <!-- Ligne 1 : Tâches -->
      <div class="indicators-row">
        <div class="indicator-card" 
             *ngFor="let indicator of keyIndicators.slice(0, 3)"
             (click)="onIndicatorClick(indicator)">
          <div class="indicator-icon-container" [style.background-color]="indicator.color + '20'">
            <ion-icon [name]="indicator.icon" 
                     [style.color]="indicator.color"
                     class="indicator-icon">
            </ion-icon>
          </div>
          <div class="indicator-content">
            <div class="indicator-label">{{ indicator.label }}</div>
            <div class="indicator-value">{{ indicator.value }}</div>
          </div>
        </div>
      </div>

      <!-- Ligne 2 : Ressources et Finances -->
      <div class="indicators-row">
        <div class="indicator-card" 
             *ngFor="let indicator of keyIndicators.slice(3, 6)"
             [ngClass]="{'finance-card': indicator.action === 'caisse'}"
             (click)="onIndicatorClick(indicator)">
          <div class="indicator-icon-container" [style.background-color]="indicator.color + '20'">
            <ion-icon [name]="indicator.icon" 
                     [style.color]="indicator.color"
                     class="indicator-icon">
            </ion-icon>
          </div>
          <div class="indicator-content">
            <div class="indicator-label">{{ indicator.label }}</div>
            <div class="indicator-value">{{ indicator.value }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- 4. INFORMATIONS SUPPLÉMENTAIRES -->
    <div class="additional-info-section">
      <h3 class="section-subtitle">Informations complémentaires</h3>
      
      <div class="info-cards">
        <div class="info-card">
          <ion-icon name="construct-outline" class="card-icon"></ion-icon>
          <div class="card-content">
            <div class="card-label">Type de construction</div>
            <div class="card-value">{{ projet.constructionType || 'Non renseigné' }}</div>
          </div>
        </div>
        
        <div class="info-card">
          <ion-icon name="person-outline" class="card-icon"></ion-icon>
          <div class="card-content">
            <div class="card-label">Chef de projet</div>
            <div class="card-value">{{ projet.projectManagerName || 'Non assigné' }}</div>
          </div>
        </div>
        
        <div class="info-card">
          <ion-icon name="business-outline" class="card-icon"></ion-icon>
          <div class="card-content">
            <div class="card-label">Client</div>
            <div class="card-value">{{ projet.partnerName || 'Non renseigné' }}</div>
          </div>
        </div>

        <!-- Description -->
        <div class="info-card" *ngIf="projet.description">
          <ion-icon name="document-text-outline" class="card-icon"></ion-icon>
          <div class="card-content">
            <div class="card-label">Description</div>
            <div class="card-value description-text" [innerHTML]="projet.description"></div>
          </div>
        </div>

        <!-- Nouvelles informations -->
        <div class="info-card">
          <ion-icon name="calendar-outline" class="card-icon"></ion-icon>
          <div class="card-content">
            <div class="card-label">Date de création</div>
            <div class="card-value">{{ projet.createDate ? (projet.createDate | date:'dd/MM/yyyy') : 'Non renseigné' }}</div>
          </div>
        </div>

        <div class="info-card">
          <ion-icon name="create-outline" class="card-icon"></ion-icon>
          <div class="card-content">
            <div class="card-label">Dernière modification</div>
            <div class="card-value">{{ projet.writeDate ? (projet.writeDate | date:'dd/MM/yyyy') : 'Non renseigné' }}</div>
          </div>
        </div>

        <!-- Informations sur les heures -->
        <div class="info-card">
          <ion-icon name="time-outline" class="card-icon"></ion-icon>
          <div class="card-content">
            <div class="card-label">Heures réalisées</div>
            <div class="card-value">{{ projet.effectiveHours || 0 }}h</div>
          </div>
        </div>

        <!-- Informations sur le site -->
        <div class="info-card" *ngIf="projet.siteArea || projet.siteWidth || projet.siteLength">
          <ion-icon name="location-outline" class="card-icon"></ion-icon>
          <div class="card-content">
            <div class="card-label">Superficie du site</div>
            <div class="card-value">{{ getSiteInfo() }}</div>
          </div>
        </div>

        <!-- Carte -->
        <div class="info-card map-card" *ngIf="projet.latitude && projet.longitude">
          <ion-icon name="map-outline" class="card-icon"></ion-icon>
          <div class="card-content">
            <div class="card-label">Localisation</div>
            <div id="map" class="map-container"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</ion-content> 