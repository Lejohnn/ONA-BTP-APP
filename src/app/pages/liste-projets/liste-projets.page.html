<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/dashboard"></ion-back-button>
    </ion-buttons>
    <ion-title>ONA BTP - Liste des Projets</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="refreshProjets()">
        <ion-icon name="refresh-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Indicateur de statut hors ligne -->
  <div *ngIf="!isOnline" class="offline-indicator">
    <ion-icon name="cloud-offline-outline"></ion-icon>
    <span>Mode hors ligne - Données en cache</span>
  </div>

  <!-- État de chargement -->
  <div *ngIf="isLoading" class="loading-state">
    <ion-spinner name="crescent"></ion-spinner>
    <p>Chargement des projets...</p>
  </div>

  <!-- État d'erreur -->
  <div *ngIf="!isLoading && errorMessage" class="error-state">
    <ion-icon name="alert-circle-outline" class="error-icon"></ion-icon>
    <p>{{ errorMessage }}</p>
    <ion-button fill="outline" (click)="refreshProjets()">
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      Réessayer
    </ion-button>
  </div>

  <!-- Liste des projets -->
  <div *ngIf="!isLoading && !errorMessage && projets.length > 0" class="projects-container">
    <div class="projects-header">
      <h2 class="projects-title">Mes Projets ({{ projets.length }})</h2>
      <div class="projects-stats">
        <div class="stat-item">
          <ion-icon name="construct-outline"></ion-icon>
          <span>{{ getProjetsEnCours() }} en cours</span>
        </div>
        <div class="stat-item">
          <ion-icon name="checkmark-circle-outline"></ion-icon>
          <span>{{ getProjetsTermines() }} terminés</span>
        </div>
      </div>
    </div>

    <div class="project-list">
      <div *ngFor="let projet of projets" class="project-card" (click)="voirDetails(projet.id)">
        <div class="project-image-container">
          <!-- Image statique comme demandé par l'encadreur -->
          <img src="assets/images/projects/default-project.webp" 
               [alt]="'Projet ' + projet.name"
               class="project-img-full"
               (error)="onImageError($event, projet)"
               loading="lazy">
          <div class="project-overlay">
            <div class="project-status" [ngClass]="getStatusClass(projet.state)">
              {{ projet.getStateDisplay() }}
            </div>
            <div class="project-type" [ngClass]="getTypeClass(projet.constructionType)">
              {{ projet.getConstructionTypeDisplay() }}
            </div>
          </div>
        </div>

        <div class="project-info">
          <h3 class="project-name">{{ projet.name }}</h3>
          <p class="project-client" *ngIf="projet.partnerName">
            <ion-icon name="business-outline"></ion-icon>
            {{ projet.partnerName }}
          </p>
          
          <div class="project-details">
            <div class="project-location" *ngIf="projet.hasLocation()">
              <ion-icon name="location-outline"></ion-icon>
              <span>{{ projet.siteName || 'Localisation disponible' }}</span>
            </div>
            <div class="project-type" [ngClass]="getTypeClass(projet.constructionType)">
              <ion-icon name="construct-outline"></ion-icon>
              {{ projet.getConstructionTypeDisplay() }}
            </div>
          </div>

          <div class="project-responsible" *ngIf="projet.projectManagerName">
            <ion-icon name="person-outline"></ion-icon>
            <span>{{ projet.projectManagerName }}</span>
          </div>

          <div class="project-progress-section">
            <div class="progress-info">
              <span class="progress-label">Progression</span>
              <span class="progress-percentage">{{ projet.getProgressDisplay() }}</span>
            </div>
            <div class="project-progress" [ngClass]="getProgressClass(projet.constructionType)">
              <div class="progress-bar" [style.width.%]="projet.progress"></div>
            </div>
          </div>

          <div class="project-meta">
            <div class="meta-item" *ngIf="projet.startDate">
              <ion-icon name="calendar-outline"></ion-icon>
              <span>Début: {{ projet.getFormattedStartDate() }}</span>
            </div>
            <div class="meta-item" *ngIf="projet.endDate">
              <ion-icon name="calendar-outline"></ion-icon>
              <span>Fin: {{ projet.getFormattedEndDate() }}</span>
            </div>
            <div class="meta-item">
              <ion-icon name="list-outline"></ion-icon>
              <span>{{ projet.taskCount }} tâches</span>
            </div>
          </div>
        </div>

        <div class="project-actions">
          <ion-button fill="clear" size="small" (click)="voirDetails(projet.id)">
            <ion-icon name="eye-outline" slot="start"></ion-icon>
            Voir détails
          </ion-button>
        </div>
      </div>
    </div>
  </div>

  <!-- État vide -->
  <div *ngIf="!isLoading && !errorMessage && projets.length === 0" class="empty-state">
    <ion-icon name="folder-open-outline" class="empty-icon"></ion-icon>
    <h3>Aucun projet trouvé</h3>
    <p>Vous n'avez pas encore de projets assignés.</p>
    <ion-button fill="outline" (click)="refreshProjets()">
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      Actualiser
    </ion-button>
  </div>
</ion-content> 