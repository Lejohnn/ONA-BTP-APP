<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/liste-taches"></ion-back-button>
    </ion-buttons>
    <ion-title>ONA BTP - Créer Tâche</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" [scrollY]="true">
  <form [formGroup]="tacheForm" class="creer-tache-form">
    <!-- Nom de la tâche -->
    <ion-item>
      <ion-label position="stacked">Nom de la tâche *</ion-label>
      <ion-input 
        formControlName="name" 
        placeholder="Entrez le nom de la tâche"
        [class.ion-invalid]="tacheForm.get('name')?.invalid && tacheForm.get('name')?.touched">
      </ion-input>
    </ion-item>
    <div *ngIf="tacheForm.get('name')?.invalid && tacheForm.get('name')?.touched" class="error-message">
      Le nom de la tâche est requis
    </div>

    <!-- Description -->
    <ion-item>
      <ion-label position="stacked">Description</ion-label>
      <ion-textarea 
        formControlName="description" 
        placeholder="Décrivez la tâche..."
        rows="3">
      </ion-textarea>
    </ion-item>

    <!-- Projet -->
    <ion-item>
      <ion-label position="stacked">Projet</ion-label>
      <ion-select 
        formControlName="projectId" 
        placeholder="Sélectionnez un projet"
        [disabled]="isLoadingProjects">
        <ion-select-option value="">Aucun projet</ion-select-option>
        <ion-select-option *ngFor="let project of projects" [value]="project.id">
          {{ project.name }}
        </ion-select-option>
      </ion-select>
      <ion-spinner *ngIf="isLoadingProjects" name="crescent"></ion-spinner>
    </ion-item>

    <!-- Employé assigné -->
    <ion-item>
      <ion-label position="stacked">Employé assigné</ion-label>
      <ion-select 
        formControlName="userId" 
        placeholder="Sélectionnez un employé"
        [disabled]="isLoadingEmployees">
        <ion-select-option value="">Aucun employé</ion-select-option>
        <ion-select-option *ngFor="let employee of employees" [value]="employee.id">
          {{ employee.name }}
        </ion-select-option>
      </ion-select>
      <ion-spinner *ngIf="isLoadingEmployees" name="crescent"></ion-spinner>
    </ion-item>

    <!-- Date limite -->
    <ion-item>
      <ion-label position="stacked">Date limite</ion-label>
      <ion-datetime 
        formControlName="dateDeadline"
        presentation="date"
        placeholder="Sélectionnez une date limite">
      </ion-datetime>
    </ion-item>

    <!-- Priorité -->
    <ion-item>
      <ion-label position="stacked">Priorité</ion-label>
      <ion-select formControlName="priority">
        <ion-select-option value="0">Normale</ion-select-option>
        <ion-select-option value="1">Élevée</ion-select-option>
        <ion-select-option value="2">Très élevée</ion-select-option>
      </ion-select>
    </ion-item>

    <!-- <div class="dates-inline-row">
      <ion-input
        class="date-inline-input"
        formControlName="startDate"
        placeholder="Start Date"
        type="text">
      </ion-input>
      <ion-input
        class="date-inline-input"
        formControlName="endDate"
        placeholder="End Date"
        type="text">
      </ion-input>
    </div> -->

    <div class="progress-row">
      <ion-label>Expected Progress</ion-label>
      <ion-label class="progress-value">{{ expectedProgress }}%</ion-label>
    </div>
    <ion-range min="0" max="100" step="1" [value]="expectedProgress" (ionChange)="onProgressChange($event)"></ion-range>
    <!-- <ion-progress-bar [value]="expectedProgress/100" class="detail-tache-progress"></ion-progress-bar> -->

    <div class="weather-row">
      <ion-label>Weather Sensitive</ion-label>
      <ion-toggle slot="end" [checked]="weatherSensitive" (ionChange)="onToggleWeatherSensitive($event)"></ion-toggle>
    </div>

    <div class="photo-section">
      <img src="assets/images/taches/takePhoto.webp" class="photo-img-large" alt="Take photo" />
    </div>
    <div class="photo-buttons-row">
      <ion-button expand="block" fill="solid" class="photo-btn" (click)="takePhoto()">Take Photo</ion-button>
      <ion-button expand="block" fill="solid" class="photo-btn" (click)="importPhoto()">Import Photo</ion-button>
    </div>

    <ion-label class="section-label">Resources</ion-label>
    <div class="resource-row">
      <ion-icon name="people" class="resource-icon-img"></ion-icon>
      <div class="resource-info">
        <div class="resource-title">Masons</div>
        <div class="resource-details">2 • 3d</div>
      </div>
      <ion-icon name="chevron-forward-outline" class="resource-arrow"></ion-icon>
    </div>
    <ion-button expand="block" fill="solid" class="add-resource-btn" (click)="addHumanResource()">Add Human Resources</ion-button>
    <div class="resource-row">
      <ion-icon name="construct" class="resource-icon-img"></ion-icon>
      <div class="resource-info">
        <div class="resource-title">Materials</div>
        <div class="resource-details">5 • 2d</div>
      </div>
      <ion-icon name="chevron-forward-outline" class="resource-arrow"></ion-icon>
    </div>
    <ion-button expand="block" fill="solid" class="add-resource-btn" (click)="addMaterialResource()">Add Material Resources</ion-button>

    <ion-button 
      expand="block" 
      fill="solid" 
      class="create-btn" 
      (click)="onCreate()"
      [disabled]="isLoading || !tacheForm.valid">
      <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
      {{ isLoading ? 'Création...' : 'Créer la tâche' }}
    </ion-button>
  </form>
</ion-content> 